<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossRealm • On-Chain Chess</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --orange: #f7931a; --dark: #0f0f0f; --card: #1a1a1a; --border: #2a2a2a;
            --text: #e0e0e0; --dim: #999; --success: #00c851; --error: #ff4444;
        }
        body { font-family: 'Courier New', monospace; background: var(--dark); color: var(--text); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: var(--card); border: 2px solid var(--orange); padding: 25px; margin-bottom: 30px; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(247,147,26,0.1), transparent); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0%,100% { transform: translateX(-100%); } 50% { transform: translateX(100%); } }
        .logo { font-size: 32px; font-weight: bold; color: var(--orange); text-transform: uppercase; letter-spacing: 3px; }
        .tagline { color: var(--dim); font-size: 12px; text-transform: uppercase; letter-spacing: 2px; }
        .wallet-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 15px; flex-wrap: wrap; }
        .wallet-status { font-size: 12px; color: var(--dim); padding: 8px 15px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .wallet-address { color: var(--orange); font-weight: bold; }
        button {
            background: linear-gradient(135deg, var(--orange), #cc6600); color: #000; border: none; padding: 12px 30px;
            font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(247,147,26,0.3); }
        button:disabled { background: var(--border); color: var(--dim); cursor: not-allowed; opacity: 0.5; }
        .grid { display: grid; grid-template-columns: 400px 1fr 400px; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 1200px) { .grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .card { background: var(--card); border: 1px solid var(--border); padding: 25px; }
        .card-header { border-bottom: 2px solid var(--orange); padding-bottom: 15px; margin-bottom: 20px; }
        .card-title { font-size: 18px; text-transform: uppercase; color: var(--orange); letter-spacing: 2px; }
        .chess-board { display: grid; grid-template-columns: repeat(8,1fr); gap: 0; max-width: 600px; margin: 0 auto; border: 3px solid var(--orange); aspect-ratio: 1; }
        .chess-square { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; }
        .chess-square.light { background: #3a3a3a; }
        .chess-square.dark { background: #1a1a1a; }
        .chess-square:hover { background: rgba(247,147,26,0.2); }
        .chess-square.selected { background: #cc6600; }
        .game-controls { text-align: center; margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px; }
        .game-status { color: var(--orange); }
        .player-color { color: var(--success); font-weight: bold; }
        .game-list { max-height: 500px; overflow-y: auto; }
        .game-item { background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; }
        .game-item:hover { border-color: var(--orange); }
        .game-meta { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .game-id { color: var(--orange); font-weight: bold; }
        input { width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: var(--text); margin-top: 8px; }
        .alert { padding: 15px; margin-bottom: 15px; border-left: 4px solid; background: rgba(0,0,0,0.5); animation: slide 0.3s; }
        @keyframes slide { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .alert-success { border-color: var(--success); color: var(--success); }
        .alert-error { border-color: var(--error); color: var(--error); }
        .alert-info { border-color: var(--orange); color: var(--orange); }
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--orange); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .footer { text-align: center; padding: 30px 0; color: var(--dim); font-size: 12px; border-top: 1px solid var(--border); margin-top: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">CROSSREALM</div>
            <div class="tagline">On-Chain Chess • Core Testnet 2</div>
            <div class="wallet-bar">
                <div class="wallet-status">
                    <span id="networkStatus">Not Connected</span>
                    <span id="walletAddress" class="wallet-address"></span>
                </div>
                <div>
                    <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
                    <button id="disconnectBtn" style="display:none;" onclick="disconnectWallet()">Disconnect</button>
                </div>
            </div>
        </div>

        <div id="alertArea"></div>

        <div class="grid">
            <!-- Create Game -->
            <div class="card">
                <div class="card-header"><div class="card-title">Create Game</div></div>
                <div>
                    <label>Stake (tCORE2)</label>
                    <input type="number" id="stakeAmount" value="0.1" step="0.01" min="0.01">
                    <small style="color:var(--dim);">Min: 0.01 tCORE2</small>
                </div>
                <button onclick="createGame()" id="createBtn" disabled style="width:100%;margin-top:15px;">Create Game</button>
            </div>

            <!-- Board -->
            <div class="card">
                <div class="card-header"><div class="card-title">Game Board</div></div>
                <div id="chessBoardContainer">
                    <p style="text-align:center;color:var(--dim);padding:40px;">Create or join a game</p>
                </div>
                <div id="gameControls" class="game-controls hidden">
                    <div id="playerColor" class="player-color"></div>
                    <div id="gameStatus" class="game-status"></div>
                    <button id="resignBtn" class="hidden" onclick="resignGame(currentGameId)" style="width:100%;margin-top:10px;">Resign</button>
                    <button id="claimBtn" class="hidden" onclick="claimTimeout(currentGameId)" style="width:100%;margin-top:10px;background:var(--success);">Claim Timeout</button>
                </div>
            </div>

            <!-- Available Games -->
            <div class="card">
                <div class="card-header"><div class="card-title">Available Games</div></div>
                <button onclick="loadPendingGames()" style="width:100%;margin-bottom:15px;">Refresh</button>
                <div class="game-list" id="gamesList">
                    <p style="text-align:center;color:var(--dim);padding:20px;">Connect wallet to see games</p>
                </div>
            </div>
        </div>

        <!-- My Games -->
        <div class="card">
            <div class="card-header"><div class="card-title">My Games</div></div>
            <button onclick="loadMyGames()" style="margin-bottom:15px;">Refresh</button>
            <div class="game-list" id="myGamesList">
                <p style="text-align:center;color:var(--dim);">Connect wallet to see your games</p>
            </div>
        </div>

        <div class="footer">CrossRealm © 2025 • 100% On-Chain</div>
    </div>

    <script>
        // ============ CONFIG ============
        const CONTRACT_ADDRESS = "0x014D3817f86F175B512f31c014BcEcDe32Ac9bDA";
        const CORE_TESTNET = {
            chainId: "0x45a",
            chainName: "Core Testnet 2",
            rpcUrls: ["https://rpc.test2.btcs.network"],
            nativeCurrency: { name: "tCORE2", symbol: "tCORE2", decimals: 18 }
        };

        const ABI = [
            "function createGame() payable returns (uint256)",
            "function joinGame(uint256) payable",
            "function makeMove(uint256 gameId, uint8 from, uint8 to)",
            "function resign(uint256)",
            "function claimTimeout(uint256)",
            "function getGame(uint256) view returns (tuple(address player1, address player2, uint256 stake, address currentTurn, uint8[64] board, uint16 moveCount, uint256 lastMoveTime, address winner, uint8 status))",
            "function getPlayerGames(address) view returns (uint256[])",
            "function getPendingGames(uint256) view returns (uint256[])",
            "event GameCreated(uint256 indexed, address indexed, uint256)"
        ];

        const PIECE = { 0:'', 1:'P',2:'N',3:'B',4:'R',5:'Q',6:'K',7:'p',8:'n',9:'b',10:'r',11:'q',12:'k' };

        // ============ STATE ============
        let provider, signer, contract, userAddress;
        let currentGameId = null;
        let currentGame = null;
        let selected = null;

        // ============ HELPERS ============
        function showAlert(msg, type = 'info') {
            const area = document.getElementById('alertArea');
            const el = document.createElement('div');
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }

        function unpackGame(raw) {
            return {
                player1: raw[0],
                player2: raw[1],
                stake: raw[2],
                currentTurn: raw[3],
                board: raw[4],
                moveCount: raw[5],
                lastMoveTime: raw[6],
                winner: raw[7],
                status: raw[8]  // 0=Pending, 1=Active, 2=Completed, 3=Cancelled
            };
        }

        // ============ WALLET ============
        async function connectWallet() {
            if (!window.ethereum) return showAlert('Install MetaMask!', 'error');
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CORE_TESTNET.chainId }] });
            } catch (e) {
                if (e.code === 4902) {
                    await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [CORE_TESTNET] });
                } else throw e;
            }

            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            userAddress = await signer.getAddress(); // AWAIT THIS!
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

            document.getElementById('networkStatus').textContent = 'Core Testnet2';
            document.getElementById('walletAddress').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = 'inline-block';
            document.getElementById('createBtn').disabled = false;

            showAlert('Connected!', 'success');
            loadPendingGames();
            loadMyGames();
        }

        function disconnectWallet() {
            provider = signer = contract = userAddress = null;
            document.getElementById('networkStatus').textContent = 'Not Connected';
            document.getElementById('walletAddress').textContent = '';
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('createBtn').disabled = true;
            document.getElementById('chessBoardContainer').innerHTML = '<p style="text-align:center;color:var(--dim);padding:40px;">Create or join a game</p>';
            document.getElementById('gameControls').classList.add('hidden');
            showAlert('Disconnected', 'info');
        }

        // ============ GAME ACTIONS ============
        async function createGame() {
            const stake = document.getElementById('stakeAmount').value;
            if (parseFloat(stake) < 0.01) return showAlert('Min 0.01 tCORE2', 'error');
            try {
                const tx = await contract.createGame({ value: ethers.utils.parseEther(stake), gasLimit: 600000 });
                showAlert('Creating...', 'info');
                const receipt = await tx.wait();
                const ev = receipt.events.find(e => e.event === 'GameCreated');
                const id = ev?.args?.[0];
                showAlert('Game created!', 'success');
                if (id) setTimeout(() => loadGame(id), 2000);
                setTimeout(() => { loadPendingGames(); loadMyGames(); }, 3000);
            } catch (e) { showAlert(e.reason || e.message, 'error'); }
        }

        async function joinGame(id, stake) {
            try {
                const tx = await contract.joinGame(id, { value: ethers.utils.parseEther(stake), gasLimit: 500000 });
                await tx.wait();
                showAlert('Joined!', 'success');
                currentGameId = id;
                setTimeout(() => loadGame(id), 2000);
            } catch (e) { showAlert(e.reason || e.message, 'error'); }
        }

        async function loadGame(id) {
            try {
                const raw = await contract.getGame(id);
                currentGame = unpackGame(raw);
                currentGameId = id;
                renderBoard(currentGame.board);
                updateControls(currentGame);
            } catch (e) { console.error(e); showAlert('Load failed', 'error'); }
        }

        function renderBoard(board) {
            const html = '<div class="chess-board">' + Array.from({length:64}, (_, i) => {
                const light = (Math.floor(i/8) + i%8) % 2 === 0;
                const p = PIECE[board[i] ?? 0];
                return `<div class="chess-square ${light?'light':'dark'}" onclick="select(${i})">${p}</div>`;
            }).join('') + '</div>';
            const info = `<div style="margin-top:20px;text-align:center;">
                <div>Game #${currentGameId}</div>
                <div style="margin-top:10px;">
                    ${currentGame.status===1 ? (currentGame.currentTurn.toLowerCase()===userAddress.toLowerCase() ?
                        '<span style="color:var(--success);">Your Turn</span>' :
                        '<span style="color:var(--dim);">Waiting...</span>') :
                    `<span style="color:${currentGame.status===2?'var(--success)':'var(--error)'};">
                        ${['Pending','Active','Completed','Cancelled'][currentGame.status]}
                    </span>`}
                </div>
            </div>`;
            document.getElementById('chessBoardContainer').innerHTML = html + info;
        }

        function updateControls(g) {
            const c = document.getElementById('gameControls'); c.classList.remove('hidden');
            document.getElementById('gameStatus').textContent = `Status: ${['Pending','Active','Completed','Cancelled'][g.status]}`;
            const color = g.player1.toLowerCase()===userAddress.toLowerCase() ? 'White' : 'Black';
            document.getElementById('playerColor').textContent = `You are ${color}`;
            document.getElementById('resignBtn').classList.toggle('hidden', g.status !== 1);
            const now = Math.floor(Date.now()/1000);
            const canClaim = g.status===1 && g.currentTurn.toLowerCase()===userAddress.toLowerCase() && now > g.lastMoveTime.toNumber() + 86400;
            document.getElementById('claimBtn').classList.toggle('hidden', !canClaim);
        }

        function select(square) {
            if (!currentGame || currentGame.status !== 1 || currentGame.currentTurn.toLowerCase() !== userAddress.toLowerCase()) return;
            if (selected === null) {
                selected = square;
                document.querySelectorAll('.chess-square')[square].classList.add('selected');
            } else if (selected === square) {
                document.querySelectorAll('.chess-square')[square].classList.remove('selected');
                selected = null;
            } else {
                makeMove(selected, square);
                document.querySelectorAll('.chess-square').forEach(s => s.classList.remove('selected'));
                selected = null;
            }
        }

        async function makeMove(from, to) {
            try {
                const tx = await contract.makeMove(currentGameId, from, to, { gasLimit: 400000 });
                await tx.wait();
                showAlert('Move made!', 'success');
                setTimeout(() => loadGame(currentGameId), 2000);
            } catch (e) { showAlert('Invalid move', 'error'); }
        }

        async function resignGame(id) {
            try { const tx = await contract.resign(id); await tx.wait(); showAlert('Resigned', 'info'); loadGame(id); }
            catch (e) { showAlert('Failed', 'error'); }
        }

        async function claimTimeout(id) {
            try { const tx = await contract.claimTimeout(id); await tx.wait(); showAlert('Timeout claimed!', 'success'); loadGame(id); }
            catch (e) { showAlert('Failed', 'error'); }
        }

        // ============ LISTS ============
        async function loadPendingGames() {
            const list = document.getElementById('gamesList');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                const ids = await contract.getPendingGames(10);
                if (!ids.length) return list.innerHTML = '<p style="text-align:center;color:var(--dim);">No games</p>';
                let html = '';
                for (const id of ids) {
                    const g = await contract.getGame(id);
                    const stake = ethers.utils.formatEther(g.stake);
                    html += `<div class="game-item">
                        <div class="game-meta"><span class="game-id">#${id}</span><span>${stake} tCORE2</span></div>
                        <button onclick="joinGame(${id},'${stake}')" style="width:100%;margin-top:10px;">Join</button>
                    </div>`;
                }
                list.innerHTML = html;
            } catch { list.innerHTML = '<p style="color:var(--error);">Error</p>'; }
        }

        async function loadMyGames() {
            if (!userAddress) return;
            const list = document.getElementById('myGamesList');
            try {
                const ids = await contract.getPlayerGames(userAddress);
                if (!ids.length) return list.innerHTML = '<p style="text-align:center;color:var(--dim);">No games</p>';
                let html = '';
                for (const id of ids) {
                    const g = await contract.getGame(id);
                    const stake = ethers.utils.formatEther(g.stake);
                    const status = ['Pending','Active','Completed','Cancelled'][g.status];
                    html += `<div class="game-item">
                        <div class="game-meta"><span class="game-id">#${id}</span><span>${status}</span></div>
                        <div style="margin-top:10px;">Stake: ${stake} tCORE2</div>
                        ${g.status <= 1 ? `<button onclick="loadGame(${id})" style="width:100%;margin-top:10px;">${g.status===0?'Waiting':'Play'}</button>` : ''}
                    </div>`;
                }
                list.innerHTML = html;
            } catch { console.error('my games error'); }
        }

        // Auto-refresh
        setInterval(() => {
            if (contract) {
                loadPendingGames();
                loadMyGames();
                if (currentGameId) loadGame(currentGameId);
            }
        }, 15000);
    </script>
</body>
</html>
