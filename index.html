<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossRealm • 4 Games on Core</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- Firebase (Optional) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bitcoin-orange: #f7931a; --burnt-orange: #cc6600; --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a; --border: #2a2a2a; --text: #e0e0e0; --text-dim: #999;
            --success: #00c851; --error: #ff4444;
        }
        body { font-family: 'Courier New', monospace; background: var(--dark-bg); color: var(--text); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: var(--card-bg); border: 2px solid var(--bitcoin-orange); padding: 25px; margin-bottom: 30px; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(247, 147, 26, 0.1), transparent); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0%, 100% { transform: translateX(-100%); } 50% { transform: translateX(100%); } }
        .logo { font-size: 32px; font-weight: bold; color: var(--bitcoin-orange); text-transform: uppercase; letter-spacing: 3px; }
        .tagline { color: var(--text-dim); font-size: 12px; text-transform: uppercase; letter-spacing: 2px; }
        .wallet-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 15px; flex-wrap: wrap; }
        .wallet-status { font-size: 12px; color: var(--text-dim); padding: 8px 15px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .wallet-address { color: var(--bitcoin-orange); font-weight: bold; }
        button { background: linear-gradient(135deg, var(--bitcoin-orange), var(--burnt-orange)); color: #000; border: none; padding: 12px 30px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; }
        button::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        button:hover::before { width: 300px; height: 300px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(247, 147, 26, 0.3); }
        button:disabled { background: var(--border); color: var(--text-dim); cursor: not-allowed; opacity: 0.5; }
        .grid { display: grid; grid-template-columns: 400px 1fr 400px; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 1200px) { .grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 25px; }
        .card-header { border-bottom: 2px solid var(--bitcoin-orange); padding-bottom: 15px; margin-bottom: 20px; }
        .card-title { font-size: 18px; text-transform: uppercase; letter-spacing: 2px; color: var(--bitcoin-orange); }
        .chess-board, .checkers-board, .fighter-ui { display: grid; grid-template-columns: repeat(8, 1fr); gap: 0; max-width: 600px; margin: 0 auto; border: 3px solid var(--bitcoin-orange); aspect-ratio: 1; }
        .square { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; transition: all 0.2s; }
        .square.light { background: #3a3a3a; } .square.dark { background: #1a1a1a; }
        .square:hover { background: rgba(247, 147, 26, 0.2); }
        .square.selected { background: var(--burnt-orange); }
        .fighter-hud { display: flex; justify-content: space-between; margin: 15px 0; }
        .fighter-player { text-align: center; }
        .hp-bar { height: 10px; background: #333; margin: 5px 0; }
        .hp-fill { height: 100%; background: #00c851; transition: width 0.5s; }
        .move-btn { margin: 5px; font-size: 12px; padding: 8px 12px; }
        .game-controls { text-align: center; margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px; }
        .game-status { font-size: 16px; margin-bottom: 10px; color: var(--bitcoin-orange); }
        .player-color { font-size: 14px; color: var(--success); margin-bottom: 5px; font-weight: bold; }
        .chat-container { height: 200px; border: 1px solid var(--border); background: rgba(0, 0, 0, 0.5); padding: 10px; overflow-y: auto; margin-top: 15px; font-size: 12px; }
        .chat-message { margin-bottom: 10px; padding: 5px; border-left: 3px solid var(--bitcoin-orange); }
        .chat-input { display: flex; gap: 10px; margin-top: 10px; }
        .chat-input input { flex: 1; }
        .game-list { max-height: 500px; overflow-y: auto; }
        .game-item { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; }
        .game-item:hover { border-color: var(--bitcoin-orange); background: rgba(247, 147, 26, 0.1); }
        .game-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .game-id { color: var(--bitcoin-orange); font-weight: bold; }
        .game-stake { color: var(--text); font-size: 14px; }
        input, select { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border); color: var(--text); margin-top: 8px; }
        input:focus, select:focus { outline: none; border-color: var(--bitcoin-orange); }
        .alert { padding: 15px; margin-bottom: 15px; border-left: 4px solid; background: rgba(0, 0, 0, 0.5); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .alert-success { border-color: var(--success); color: var(--success); }
        .alert-error { border-color: var(--error); color: var(--error); }
        .alert-info { border-color: var(--bitcoin-orange); color: var(--bitcoin-orange); }
        .hidden { display: none; }
        .footer { text-align: center; padding: 30px 0; color: var(--text-dim); font-size: 12px; border-top: 1px solid var(--border); margin-top: 40px; }
        .footer-link { color: var(--bitcoin-orange); text-decoration: none; margin: 0 10px; }
        .footer-link:hover { text-decoration: underline; }
        .spinner { border: 3px solid var(--border); border-top: 3px solid var(--bitcoin-orange); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .token-input { display: flex; gap: 10px; }
        .token-input input { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">CROSSREALM</div>
            <div class="tagline">Chess • Checkers • Poker • Fighter • Any ERC20</div>
            <div class="wallet-bar">
                <div class="wallet-status">
                    <span id="networkStatus">Not Connected</span>
                    <span id="walletAddress" class="wallet-address"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
                    <button id="disconnectBtn" class="disconnect-btn" onclick="disconnectWallet()" style="display: none;">Disconnect</button>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alertArea"></div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Create Game -->
            <div class="card">
                <div class="card-header"><div class="card-title">Create Game</div></div>
                <div class="form-group">
                    <label>Game Type</label>
                    <select id="gameType">
                        <option value="1">Chess</option>
                        <option value="2">Checkers</option>
                        <option value="3">Poker</option>
                        <option value="4">Fighter</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Wager Token</label>
                    <select id="tokenSelect">
                        <option value="0x0000000000000000000000000000000000000000">tCORE2 (Native)</option>
                        <!-- Add more tokens here -->
                    </select>
                </div>
                <div class="form-group token-input">
                    <input type="number" id="stakeAmount" placeholder="0.1" step="0.01" min="0.01" value="0.1">
                    <button onclick="approveToken()" id="approveBtn" style="display: none; padding: 12px;">Approve</button>
                </div>
                <button onclick="createGame()" id="createBtn" disabled style="width: 100%;">Create Game</button>
            </div>

            <!-- Game Board -->
            <div class="card">
                <div class="card-header"><div class="card-title" id="boardTitle">Game Board</div></div>
                <div id="gameContainer">
                    <p style="text-align: center; color: var(--text-dim); padding: 40px;">Select a game</p>
                </div>
                <div id="gameControls" class="game-controls hidden">
                    <div id="playerColor" class="player-color"></div>
                    <div id="gameStatus" class="game-status"></div>
                    <button id="resignBtn" class="resign-btn hidden" onclick="resignGame(currentGameId)">Resign</button>
                    <button id="claimBtn" class="claim-btn hidden" onclick="claimTimeout(currentGameId)">Claim Timeout</button>
                </div>
                <div id="liveChatSection" class="hidden" style="margin-top: 20px;">
                    <div class="card-header"><div class="card-title">Live Chat (Testnet)</div></div>
                    <div id="chatContainer" class="chat-container">
                        <p style="text-align: center; color: var(--text-dim);">Firebase not configured</p>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type a message..." maxlength="200">
                        <button onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>

            <!-- Available Games -->
            <div class="card">
                <div class="card-header"><div class="card-title">Available Games</div></div>
                <button onclick="loadPendingGames()" style="width: 100%; margin-bottom: 15px;">Refresh</button>
                <div class="game-list" id="gamesList">
                    <p style="text-align: center; color: var(--text-dim);">Connect wallet</p>
                </div>
            </div>
        </div>

        <!-- My Games -->
        <div class="card">
            <div class="card-header"><div class="card-title">My Games</div></div>
            <button onclick="loadMyGames()" style="margin-bottom: 15px;">Refresh</button>
            <div class="game-list" id="myGamesList">
                <p style="text-align: center; color: var(--text-dim);">Connect wallet</p>
            </div>
        </div>

        <div class="footer">
            <div>CrossRealm © 2025 • Core Testnet • ERC20 Wagers</div>
        </div>
    </div>

    <script>
        // ============ CONFIG ============
        const CONTRACT_ADDRESS = "0x70ea24005684b8811f97352fac9b7dd2f568b196";
        const CORE_TESTNET = { chainId: "0x45a", chainName: "Core Testnet2", rpcUrls: ["https://rpc.test2.btcs.network"] };

        // PLACEHOLDER FIREBASE
        let database = null;
        try {
            firebase.initializeApp({ databaseURL: "https://placeholder.firebaseio.com" });
            database = firebase.database();
        } catch (e) {}

        const PIECE_SYMBOLS = { 0: '', 1: 'P', 2: 'N', 3: 'B', 4: 'R', 5: 'Q', 6: 'K', 7: 'p', 8: 'n', 9: 'b', 10: 'r', 11: 'q', 12: 'k' };
        const CHECKERS_SYMBOLS = { 0: '', 1: '●', 2: '▲', 3: '○', 4: '△' };
        const MOVE_NAMES = ['Punch', 'Kick', 'Block', 'Special', 'Combo', 'Heal'];

        // ============ ABI (Minimal) ============
        const ABI = [
            "function createGame(uint8 kind, address token, uint256 stake) payable returns (uint256)",
            "function join(uint256 id) payable",
            "function chessMove(uint256 id, uint8 from, uint8 to)",
            "function checkersMove(uint256 id, uint8 from, uint8 to)",
            "function fighterMove(uint256 id, uint8 move)",
            "function cancel(uint256 id)",
            "function timeout(uint256 id)",
            "function games(uint256) view returns (address p1, address p2, uint256 stake, address token, address turn, uint16 moves, uint256 lastMove, address winner, uint8 status, uint8 kind, uint256 seed)",
            "function chess(uint256) view returns (uint8[64] board)",
            "function checkers(uint256) view returns (uint8[64] board)",
            "function fighter(uint256) view returns (uint8[2] hp, uint8[2] st, uint8[2] move, uint8 round)",
            "function playerGames(address) view returns (uint256[])",
            "event Created(uint256 id, address p1, uint8 kind, address token, uint256 stake)",
            "event Joined(uint256 id, address p2)"
        ];

        // ERC20 ABI (for approve)
        const ERC20_ABI = ["function approve(address spender, uint256 amount) returns (bool)", "function allowance(address owner, address spender) view returns (uint256)"];

        // ============ STATE ============
        let provider, signer, contract, userAddress;
        let currentGameId = null, currentGame = null, selectedSquare = null;

        // ============ WALLET (FIXED) ============
        async function connectWallet() {
            if (!window.ethereum) return showAlert('Install MetaMask!', 'error');
            try {
                const tempProvider = new ethers.providers.Web3Provider(window.ethereum);
                await tempProvider.send("eth_requestAccounts", []);
                try {
                    await tempProvider.send("wallet_switchEthereumChain", [{ chainId: CORE_TESTNET.chainId }]);
                } catch (e) {
                    if (e.code === 4902) await tempProvider.send("wallet_addEthereumChain", [CORE_TESTNET]);
                    else throw e;
                }
                provider = tempProvider;
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                document.getElementById('networkStatus').textContent = 'Core Testnet2';
                document.getElementById('walletAddress').textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('createBtn').disabled = false;

                showAlert('Connected!', 'success');
                loadPendingGames(); loadMyGames();
            } catch (e) {
                showAlert('Failed: ' + (e.message || 'Unknown'), 'error');
            }
        }

        function disconnectWallet() {
            provider = signer = contract = userAddress = null;
            document.getElementById('networkStatus').textContent = 'Not Connected';
            document.getElementById('walletAddress').textContent = '';
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('createBtn').disabled = true;
            document.getElementById('gameContainer').innerHTML = '<p style="text-align: center; color: var(--text-dim);">Select a game</p>';
        }

        // ============ TOKEN APPROVAL ============
        async function approveToken() {
            const tokenAddr = document.getElementById('tokenSelect').value;
            if (tokenAddr === ethers.constants.AddressZero) return;
            const amount = ethers.utils.parseEther(document.getElementById('stakeAmount').value);
            const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
            try {
                const tx = await token.approve(CONTRACT_ADDRESS, amount);
                await tx.wait();
                showAlert('Approved!', 'success');
                document.getElementById('approveBtn').style.display = 'none';
            } catch (e) { showAlert('Approve failed', 'error'); }
        }

        // ============ CREATE GAME ============
        async function createGame() {
            const kind = document.getElementById('gameType').value;
            const tokenAddr = document.getElementById('tokenSelect').value;
            const stake = ethers.utils.parseEther(document.getElementById('stakeAmount').value);

            if (tokenAddr !== ethers.constants.AddressZero) {
                const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
                const allowance = await token.allowance(userAddress, CONTRACT_ADDRESS);
                if (allowance.lt(stake)) {
                    document.getElementById('approveBtn').style.display = 'inline-block';
                    showAlert('Approve token first', 'info');
                    return;
                }
            }

            try {
                const tx = await contract.createGame(kind, tokenAddr, stake, { value: tokenAddr === ethers.constants.AddressZero ? stake : 0 });
                await tx.wait();
                showAlert('Game created!', 'success');
                setTimeout(loadPendingGames, 3000);
            } catch (e) { showAlert('Failed: ' + e.message, 'error'); }
        }

        // ============ JOIN, LOAD, RENDER (same as before) ============
        async function joinGame(id, stake, token) {
            try {
                const tx = await contract.join(id, { value: token === ethers.constants.AddressZero ? stake : 0 });
                await tx.wait();
                showAlert('Joined!', 'success');
                loadGame(id);
            } catch (e) { showAlert('Failed: ' + e.message, 'error'); }
        }

        async function loadGame(id) {
            currentGameId = id;
            currentGame = await contract.games(id);
            const kind = currentGame.kind.toNumber();
            document.getElementById('boardTitle').textContent = ['Chess','Checkers','Poker','Fighter'][kind-1];

            let html = '';
            if (kind === 1) html = await renderChess(id);
            else if (kind === 2) html = await renderCheckers(id);
            else if (kind === 4) html = await renderFighter(id);

            document.getElementById('gameContainer').innerHTML = html;
            updateControls();
        }

        async function renderChess(id) {
            const board = await contract.chess(id);
            return `<div class="chess-board">${board.map((p,i) => `<div class="square ${(Math.floor(i/8)+i%8)%2===0?'light':'dark'}" onclick="selectSquare(${i})">${PIECE_SYMBOLS[p]}</div>`).join('')}</div>`;
        }

        async function renderCheckers(id) {
            const board = await contract.checkers(id);
            return `<div class="checkers-board">${board.map((p,i) => `<div class="square ${(Math.floor(i/8)+i%8)%2===0?'light':'dark'}" onclick="selectSquare(${i})">${CHECKERS_SYMBOLS[p]}</div>`).join('')}</div>`;
        }

        async function renderFighter(id) {
            const f = await contract.fighter(id);
            return `<div class="fighter-ui">${[0,1].map(i=>`<div class="fighter-player" style="grid-column:${i===0?'1/5':'5/9'}"><div>${i===0?'You':'Opp'}</div><div class="hp-bar"><div class="hp-fill" style="width:${f.hp[i]}%"></div></div><div>HP: ${f.hp[i]} | ST: ${f.st[i]}</div><div style="margin-top:10px;">${MOVE_NAMES.map((m,j)=>`<button class="move-btn" onclick="fighterMove(${id},${j})" ${f.st[i]<[5,8,0,20,25,15][j]?'disabled':''}>${m}</button>`).join('')}</div></div>`).join('')}</div>`;
        }

        function selectSquare(pos) {
            if (!currentGame || currentGame.turn.toLowerCase() !== userAddress.toLowerCase()) return;
            if (selectedSquare === null) {
                selectedSquare = pos;
                document.querySelectorAll('.square')[pos].classList.add('selected');
            } else {
                const kind = currentGame.kind.toNumber();
                if (kind === 1) contract.chessMove(currentGameId, selectedSquare, pos);
                else if (kind === 2) contract.checkersMove(currentGameId, selectedSquare, pos);
                selectedSquare = null;
                setTimeout(() => loadGame(currentGameId), 2000);
            }
        }

        async function fighterMove(id, move) {
            await contract.fighterMove(id, move);
            setTimeout(() => loadGame(id), 2000);
        }

        function updateControls() {
            const c = document.getElementById('gameControls');
            c.classList.remove('hidden');
            document.getElementById('playerColor').textContent = currentGame.p1.toLowerCase() === userAddress.toLowerCase() ? 'Player 1' : 'Player 2';
        }

        // ============ LISTS ============
        async function loadPendingGames() {
            const list = document.getElementById('gamesList');
            list.innerHTML = '<div class="spinner"></div>';
            try {
                const ids = await contract.playerGames(ethers.constants.AddressZero); // Simulate pending
                let html = '';
                for (const id of ids) {
                    const g = await contract.games(id);
                    if (g.p2 === ethers.constants.AddressZero && g.status.toNumber() === 0) {
                        const symbol = g.token === ethers.constants.AddressZero ? 'tCORE2' : 'ERC20';
                        html += `<div class="game-item"><div class="game-meta"><span class="game-id">#${id}</span><span>${ethers.utils.formatEther(g.stake)} ${symbol}</span></div><button onclick="joinGame(${id}, '${g.stake}', '${g.token}')">Join</button></div>`;
                    }
                }
                list.innerHTML = html || '<p>No games</p>';
            } catch (e) { list.innerHTML = '<p>Error</p>'; }
        }

        async function loadMyGames() {
            const ids = await contract.playerGames(userAddress);
            const list = document.getElementById('myGamesList');
            let html = '';
            for (const id of ids) {
                const g = await contract.games(id);
                html += `<div class="game-item"><div class="game-meta"><span class="game-id">#${id}</span><span>${['Chess','Checkers','Poker','Fighter'][g.kind-1]}</span></div><button onclick="loadGame(${id})">View</button></div>`;
            }
            list.innerHTML = html || '<p>No games</p>';
        }

        function showAlert(msg, type) {
            const area = document.getElementById('alertArea');
            const el = document.createElement('div');
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }

        function sendChatMessage() { showAlert('Chat disabled (Testnet)', 'info'); }

        setInterval(() => { if (contract) { loadPendingGames(); loadMyGames(); if (currentGameId) loadGame(currentGameId); } }, 15000);
    </script>
</body>
</html>
